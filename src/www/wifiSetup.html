<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>BLLED WiFi Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            margin: 0;
            padding: 15px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        #container {
            max-width: 450px;
            width: 100%;
            z-index: 1;
        }

        #header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        h1,
        h2 {
            color: white;
        }

        #logo {
            height: 5em;
            width: auto;
            display: inline-block;
        }

        #networks {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .network {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .network:hover {
            background: #eee;
        }

        .network svg {
            width: 16px;
            height: 12px;
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }

        form {
            margin-top: 15px;
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        form label {
            display: block;
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 6px;
            margin-bottom: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        button {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <canvas id="particleCanvas" style="background: rgb(20,80,49);"></canvas>
    <div id="container">
        <div id="header">
            <img id="logo" src="/blled.png" alt="BLLED Logo">
            <h1>BLLED WiFi Setup</h1>
        </div>

        <div id="networks">Loading...</div>

        <form id="wifiForm">
            <label for="ssid">SSID</label>
            <input type="text" id="ssid" required>

            <label for="password">Password</label>
            <input type="password" id="password" required>

            <label for="printerIP">Printer IP</label>
            <input type="text" id="printerIP" placeholder="e.g. 192.168.1.100">

            <label for="printerSerial">Printer Serial Number</label>
            <input type="text" id="printerSerial" placeholder="e.g. BL123456789">

            <label for="accessCode">Printer Access Code</label>
            <input type="text" id="accessCode" placeholder="e.g. Access123">

            <label for="webUser">WebUI Security Username</label>
            <input type="text" id="webUser" placeholder="e.g. admin">

            <label for="webPass">WebUI Security Password</label>
            <input type="password" id="webPass" placeholder="e.g. password">

            <button type="submit">Save & Restart</button>
        </form>
    </div>

    <script src="particleCanvas.js"></script>

    <script>
        function getSignalSVG(rssi) {
            let level = 0;
            if (rssi >= -50) level = 4;
            else if (rssi >= -60) level = 3;
            else if (rssi >= -70) level = 2;
            else level = 1;

            return `
                <svg width="16" height="12" viewBox="0 0 20 16" preserveAspectRatio="xMidYMid meet">
                    <rect x="0" y="12" width="3" height="4" ${level >= 1 ? 'fill="#444"' : 'fill="#ccc"'}/>
                    <rect x="5" y="8" width="3" height="8" ${level >= 2 ? 'fill="#444"' : 'fill="#ccc"'}/>
                    <rect x="10" y="4" width="3" height="12" ${level >= 3 ? 'fill="#444"' : 'fill="#ccc"'}/>
                    <rect x="15" y="0" width="3" height="16" ${level >= 4 ? 'fill="#444"' : 'fill="#ccc"'}/>
                </svg>`;
        }

        function getSignalPercent(rssi) {
            let percent = Math.max(0, Math.min(100, 2 * (rssi + 100)));
            return `${percent}%`;
        }

        function getLockIcon(enc) {
            return enc ? "ðŸ”’" : "ðŸ”“";
        }

        async function loadNetworks() {
            try {
                const res = await fetch("/wifiScan");
                const data = await res.json();
                const container = document.getElementById("networks");
                container.innerHTML = "";
                data.networks.forEach(net => {
                    const div = document.createElement("div");
                    div.className = "network";
                    div.innerHTML = `
                        ${getSignalSVG(net.rssi)} ${getSignalPercent(net.rssi)} ${net.ssid} ${getLockIcon(net.enc)}
                    `;
                    div.addEventListener("click", () => {
                        document.getElementById("ssid").value = net.ssid;
                    });
                    container.appendChild(div);
                });
            } catch (err) {
                document.getElementById("networks").innerText = "Failed to load networks.";
                console.error(err);
            }
        }

        document.getElementById("wifiForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const ssid = document.getElementById("ssid").value;
            const pass = document.getElementById("password").value;
            const printerIP = document.getElementById("printerIP").value;
            const printerSerial = document.getElementById("printerSerial").value;
            const accessCode = document.getElementById("accessCode").value;
            const webUser = document.getElementById("webUser").value;
            const webPass = document.getElementById("webPass").value;

            await fetch("/submitWiFi", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `ssid=${encodeURIComponent(ssid)}&pass=${encodeURIComponent(pass)}&printerIP=${encodeURIComponent(printerIP)}&printerSerial=${encodeURIComponent(printerSerial)}&accessCode=${encodeURIComponent(accessCode)}&webUser=${encodeURIComponent(webUser)}&webPass=${encodeURIComponent(webPass)}`
            });
            alert("WiFi & Printer settings saved. Restarting...");
        });
        async function loadPrinterConfig() {
            try {
                const res = await fetch("/config.json");
                const config = await res.json();
                document.getElementById("ssid").value = config.ssid || "";
                document.getElementById("password").value = config.pass || "";
                document.getElementById("printerIP").value = config.printerIP || "";
                document.getElementById("printerSerial").value = config.printerSerial || "";
                document.getElementById("accessCode").value = config.accessCode || "";
                document.getElementById("webUser").value = config.webUser || "";
                document.getElementById("webPass").value = config.webPass || "";
            } catch (err) {
                console.warn("No existing config found or failed to load.");
            }
        }
        loadPrinterConfig();
        loadNetworks();
    </script>
</body>

</html>